<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>RootCore Packages: /cvmfs/atlas.cern.ch/repo/sw/ASG/AnalysisBase/2.4.30/CxxUtils/CxxUtils/fpcompare.h File Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="../../search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>/cvmfs/atlas.cern.ch/repo/sw/ASG/AnalysisBase/2.4.30/CxxUtils/CxxUtils/fpcompare.h File Reference</h1>
<p>Workaround x86 precision issues for FP inequality comparisons.  
<a href="#_details">More...</a></p>
<code>#include &lt;cmath&gt;</code><br/>
<code>#include &lt;functional&gt;</code><br/>

<p><a href="../../df/df0/fpcompare_8h_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dd/d29/structCxxUtils_1_1fpcompare__fn_1_1equal.html">CxxUtils::fpcompare_fn::equal</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="../../dd/d29/structCxxUtils_1_1fpcompare__fn_1_1equal.html#_details">More...</a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/d7a/structCxxUtils_1_1fpcompare__fn_1_1equalf.html">CxxUtils::fpcompare_fn::equalf</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="../../d4/d7a/structCxxUtils_1_1fpcompare__fn_1_1equalf.html#_details">More...</a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/d03/structCxxUtils_1_1fpcompare__fn_1_1greater.html">CxxUtils::fpcompare_fn::greater</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="../../d4/d03/structCxxUtils_1_1fpcompare__fn_1_1greater.html#_details">More...</a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d3/ddd/structCxxUtils_1_1fpcompare__fn_1_1greaterf.html">CxxUtils::fpcompare_fn::greaterf</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="../../d3/ddd/structCxxUtils_1_1fpcompare__fn_1_1greaterf.html#_details">More...</a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/ded/structCxxUtils_1_1fpcompare__fn_1_1less.html">CxxUtils::fpcompare_fn::less</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="../../dc/ded/structCxxUtils_1_1fpcompare__fn_1_1less.html#_details">More...</a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d2/d91/structCxxUtils_1_1fpcompare__fn_1_1lessf.html">CxxUtils::fpcompare_fn::lessf</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="../../d2/d91/structCxxUtils_1_1fpcompare__fn_1_1lessf.html#_details">More...</a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/db2/structCxxUtils_1_1fpcompare__fn_1_1greater__equal.html">CxxUtils::fpcompare_fn::greater_equal</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="../../d7/db2/structCxxUtils_1_1fpcompare__fn_1_1greater__equal.html#_details">More...</a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/dc0/structCxxUtils_1_1fpcompare__fn_1_1greater__equalf.html">CxxUtils::fpcompare_fn::greater_equalf</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="../../d1/dc0/structCxxUtils_1_1fpcompare__fn_1_1greater__equalf.html#_details">More...</a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d5/dbd/structCxxUtils_1_1fpcompare__fn_1_1less__equal.html">CxxUtils::fpcompare_fn::less_equal</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="../../d5/dbd/structCxxUtils_1_1fpcompare__fn_1_1less__equal.html#_details">More...</a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/d11/structCxxUtils_1_1fpcompare__fn_1_1less__equalf.html">CxxUtils::fpcompare_fn::less_equalf</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="../../d1/d11/structCxxUtils_1_1fpcompare__fn_1_1less__equalf.html#_details">More...</a><br/></td></tr>
<tr><td colspan="2"><h2>Namespaces</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">namespace &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../de/d12/namespaceCxxUtils.html">CxxUtils</a></td></tr>

<p><tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight"><p>Copy the elements of a sequence for which a predicate is true. </p>
<br/></td></tr>
</p>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d3/de9/namespaceCxxUtils_1_1fpcompare.html#a0865c5fb9647b43166777aadcabb2d87">CxxUtils::fpcompare::equal</a> (double a, double b)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="#a0865c5fb9647b43166777aadcabb2d87"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d3/de9/namespaceCxxUtils_1_1fpcompare.html#a3212a2a06e0384678e7ab394418cbf49">CxxUtils::fpcompare::equal</a> (float a, float b)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="#a3212a2a06e0384678e7ab394418cbf49"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d3/de9/namespaceCxxUtils_1_1fpcompare.html#a096c5904dd129caefb3eb6a93c21d653">CxxUtils::fpcompare::greater</a> (double a, double b)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="#a096c5904dd129caefb3eb6a93c21d653"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d3/de9/namespaceCxxUtils_1_1fpcompare.html#a30a5081a4d1b88cd09cb7f6756fc2fe8">CxxUtils::fpcompare::greater</a> (float a, float b)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="#a30a5081a4d1b88cd09cb7f6756fc2fe8"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d3/de9/namespaceCxxUtils_1_1fpcompare.html#a7a9fa58aa06b1b2afa0fe03a01c9948d">CxxUtils::fpcompare::less</a> (double a, double b)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="#a7a9fa58aa06b1b2afa0fe03a01c9948d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d3/de9/namespaceCxxUtils_1_1fpcompare.html#a8507a731bb5ad0716584538f15d82ea7">CxxUtils::fpcompare::less</a> (float a, float b)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="#a8507a731bb5ad0716584538f15d82ea7"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d3/de9/namespaceCxxUtils_1_1fpcompare.html#ae62e91519a8322b4774e7ecf0a27a705">CxxUtils::fpcompare::greater_equal</a> (double a, double b)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="#ae62e91519a8322b4774e7ecf0a27a705"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d3/de9/namespaceCxxUtils_1_1fpcompare.html#a18000651a35495e15cbceb0e4a8bb1da">CxxUtils::fpcompare::greater_equal</a> (float a, float b)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="#a18000651a35495e15cbceb0e4a8bb1da"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d3/de9/namespaceCxxUtils_1_1fpcompare.html#a88e80616613961580aede5e3a13bc456">CxxUtils::fpcompare::less_equal</a> (double a, double b)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="#a88e80616613961580aede5e3a13bc456"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d3/de9/namespaceCxxUtils_1_1fpcompare.html#a28d1be1e7e67ace904d3ae1f32a64d0b">CxxUtils::fpcompare::less_equal</a> (float a, float b)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compare two FP numbers, working around x87 precision issues.  <a href="#a28d1be1e7e67ace904d3ae1f32a64d0b"></a><br/></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>Workaround x86 precision issues for FP inequality comparisons. </p>
<dl class="author"><dt><b>Author:</b></dt><dd>scott snyder </dd></dl>
<dl class="date"><dt><b>Date:</b></dt><dd>Sep 2008 The functions contained here can be used to work around one of the effects of the brain-damage of the x87 FPU.</dd></dl>
<p>Brief summary: If you're writing a comparison function for sort, where the comparison depends on computed floating-point values, eg:</p>
<div class="fragment"><pre class="fragment">    <span class="keywordtype">bool</span> compare (IParticle* a, IParticle* b)
    { <span class="keywordflow">return</span> a-&gt;pt() &gt; b-&gt;pt(); }
</pre></div><p>then you should replace the comparison with a call to one of the functions in this file:</p>
<div class="fragment"><pre class="fragment">    <span class="keywordtype">bool</span> compare (IParticle* a, IParticle* b)
    { <span class="keywordflow">return</span> CxxUtils::fpcompare::greater (a-&gt;pt(), b-&gt;pt()); }
</pre></div><p>Longer explanation:</p>
<p>An expression like this (where pt() returns a double):</p>
<div class="fragment"><pre class="fragment">    a-&gt;pt() &gt; b-&gt;pt()
</pre></div><p>is compiled (on x86) into a sequence like this:</p>
<p>call a-&gt;pt() save result from FPU to a double stack temporary call b-&gt;pt() load the temporary back into the FPU do the comparison</p>
<p>If pt() returns a result with the extra precision bits used (so that the value changes when rounded to a double), then it is possible for this comparison to return true for the case where a==b. This violates the assumptions that std::sort makes of the comparison function, and can cause a crash (possibly even silently wrong results!).</p>
<p>As a fix, we force both parameters into something that has been declared <code>volatile</code>. That forces them to be spilled to memory, ensuring that they are both correctly rounded for the declared data type. The comparison is then done on these rounded values.</p>
<p>We condition this on the parameter <code>__FLT_EVAL_METHOD__</code> being 2. This is defined in the <a class="el" href="../../db/db2/structC.html">C</a> standard; a value of 2 means that all FP calculations are done as long double. For other cases, we leave out the <code>volatile</code> qualifiers; this should result in the functions being inlined completely away.</p>
<p>In addition to the free functions in the <code>CxxUtils::fpcompare</code> namespace. we define corresponding functionals in the <code>CxxUtils::fpcompare_fn</code> namespace.</p>
<p>It's also worth pointing out that exactly the same issue arises if one uses a floating-point value as the key for a STL associative container. In that case, this comparison instability may cause the container to become corrupted. While it's probably best to avoid using floats for associative container keys in the first place, if you do have to do that, you can work around this problem by using one of the above functionals as the container's comparison type. </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on 15 Apr 2017 for RootCore Packages by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
